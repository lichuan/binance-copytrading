<html>
  <head>
    <meta charset="UTF-8">
    <title>It's a trading chart.</title>
    <link rel="icon" type="image/png" sizes="50x50" href="assets/icons8-binance-50.png">
    <style type="text/css">
      textarea {
        width: 1270;
        height: 47;
        margin-top: 1;
      }
    </style>
  </head>
  <body>
    <div>
      <select id="symbol" onchange="updateSymbol()">
        <option value="BTCUSDT:1:3">BTCUSDT</option>
        <option value="ETHUSDT:2:3">ETHUSDT</option>
        <option value="SOLUSDT:2:0">SOLUSDT</option>
        <option value="WCTUSDT:4:0">WCTUSDT</option>
        <option value="LPTUSDT:3:1">LPTUSDT</option>
        <option value="XRPUSDT:4:1">XRPUSDT</option>
        <option value="DOGEUSDT:5:0">DOGEUSDT</option>
        <option value="1000PEPEUSDT:7:0">1000PEPEUSDT</option>
        <option value="LINKUSDT:3:2">LINKUSDT</option>
        <option value="SUIUSDT:4:1">SUIUSDT</option>
        <option value="TRBUSDT:3:1">TRBUSDT</option>
        <option value="TAOUSDT:2:3">TAOUSDT</option>
        <option value="SOPHUSDT:6:0">SOPHUSDT</option>
        <option value="MOODENGUSDT:5:0">MOODENGUSDT</option>
        <option value="NXPCUSDT:5:0">NXPCUSDT</option>
        <option value="KAITOUSDT:4:1">KAITOUSDT</option>
        <option value="SOLVUSDT:5:0">SOLVUSDT</option>
        <option value="HYPEUSDT:3:2">HYPEUSDT</option>
        <option value="PNUTUSDT:5:0">PNUTUSDT</option>
        <option value="ETHFIUSDT:4:1">ETHFIUSDT</option>
        <option value="TSTUSDT:4:0">TSTUSDT</option>
        <option value="HUMAUSDT:6:0">HUMAUSDT</option>
        <option value="BUSDT:5:0">BUSDT</option>
        <option value="SOONUSDT:5:0">SOONUSDT</option>
        <option value="TUTUSDT:5:0">TUTUSDT</option>
        <option value="OMUSDT:5:1">OMUSDT</option>
        <option value="INITUSDT:4:0">INITUSDT</option>
        <option value="UXLINKUSDT:4:0">UXLINKUSDT</option>
        <option value="EIGENUSDT:4:1">EIGENUSDT</option>
        <option value="HAEDALUSDT:6:0">HAEDALUSDT</option>
        <option value="SYRUPUSDT:5:0">SYRUPUSDT</option>
        <option value="MUBARAKUSDT:5:0">MUBARAKUSDT</option>
        <option value="PEOPLEUSDT:5:0">PEOPLEUSDT</option>
        <option value="AIOTUSDT:5:0">AIOTUSDT</option>
        <option value="PROMPTUSDT:4:0">PROMPTUSDT</option>
        <option value="RENDERUSDT:3:1">RENDERUSDT</option>
        <option value="DFUSDT:5:0">DFUSDT</option>
        <option value="KERNELUSDT:4:0">KERNELUSDT</option>
        <option value="DEGOUSDT:4:1">DEGOUSDT</option>
        <option value="LAYERUSDT:4:1">LAYERUSDT</option>
        <option value="FLMUSDT:4:0">FLMUSDT</option>
        <option value="GOATUSDT:5:0">GOATUSDT</option>
        <option value="PARTIUSDT:4:0">PARTIUSDT</option>
        <option value="TNSRUSDT:4:1">TNSRUSDT</option>
        <option value="BERAUSDT:3:1">BERAUSDT</option>
        <option value="SSVUSDT:3:2">SSVUSDT</option>
        <option value="BRETTUSDT:5:0">BRETTUSDT</option>
        <option value="NMRUSDT:3:1">NMRUSDT</option>
        <option value="CAKEUSDT:4:0">CAKEUSDT</option>
        <option value="AUSDT:5:0">AUSDT</option>
        <option value="ANIMEUSDT:5:0">ANIMEUSDT</option>
        <option value="CETUSUSDT:5:0">CETUSUSDT</option>
        <option value="ZECUSDT:2:3">ZECUSDT</option>
        <option value="SUSDT:4:0">SUSDT</option>
        <option value="LQTYUSDT:4:1">LQTYUSDT</option>
        <option value="IPUSDT:5:1">IPUSDT</option>
        <option value="SIGNUSDT:5:0">SIGNUSDT</option>
        <option value="CATIUSDT:4:0">CATIUSDT</option>
        <option value="DEGENUSDT:6:0">DEGENUSDT</option>
        <option value="SAFEUSDT:4:0">SAFEUSDT</option>
        <option value="USUALUSDT:4:0">USUALUSDT</option>
        <option value="SPELLUSDT:7:0">SPELLUSDT</option>
        <option value="XVGUSDT:7:0">XVGUSDT</option>
        <option value="IOTXUSDT:5:0">IOTXUSDT</option>
        <option value="XMRUSDT:2:3">XMRUSDT</option>
        <option value="KAVAUSDT:4:1">KAVAUSDT</option>
        <option value="NEIROETHUSDT:5:0">NEIROETHUSDT</option>
        <option value="NILUSDT:4:1">NILUSDT</option>
        <option value="DOODUSDT:7:0">DOODUSDT</option>
        <option value="ATHUSDT:5:0">ATHUSDT</option>
        <option value="ACTUSDT:5:0">ACTUSDT</option>
        <option value="KMNOUSDT:5:0">KMNOUSDT</option>
        <option value="B2USDT:4:0">B2USDT</option>
        <option value="PAXGUSDT:2:3">PAXGUSDT</option>
        <option value="BIOUSDT:5:0">BIOUSDT</option>
        <option value="ICXUSDT:4:0">ICXUSDT</option>
        <option value="BABYUSDT:5:0">BABYUSDT</option>
        <option value="BMTUSDT:4:0">BMTUSDT</option>
        <option value="SKYAIUSDT:5:0">SKYAIUSDT</option>
        <option value="GPSUSDT:5:0">GPSUSDT</option>
        <option value="SXTUSDT:5:0">SXTUSDT</option>
        <option value="VOXELUSDT:5:0">VOXELUSDT</option>
        <option value="QNTUSDT:2:1">QNTUSDT</option>
        <option value="BANANAUSDT:3:1">BANANAUSDT</option>
        <option value="SAGAUSDT:4:1">SAGAUSDT</option>
        <option value="VINEUSDT:5:0">VINEUSDT</option>
        <option value="POLUSDT:5:0">POLUSDT</option>
        <option value="MERLUSDT:5:0">MERLUSDT</option>
        <option value="GRASSUSDT:4:1">GRASSUSDT</option>
        <option value="AERGOUSDT:5:0">AERGOUSDT</option>
        <option value="PORTALUSDT:4:1">PORTALUSDT</option>
        <option value="AGTUSDT:6:0">AGTUSDT</option>
        <option value="PUNDIXUSDT:4:0">PUNDIXUSDT</option>
        <option value="BANANAS31USDT:6:0">BANANAS31USDT</option>
        <option value="OGNUSDT:4:0">OGNUSDT</option>
        <option value="COWUSDT:4:0">COWUSDT</option>
        <option value="JELLYJELLYUSDT:5:0">JELLYJELLYUSDT</option>
        <option value="FHEUSDT:5:0">FHEUSDT</option>
        <option value="WALUSDT:4:0">WALUSDT</option>
        <option value="GUNUSDT:5:0">GUNUSDT</option>
        <option value="ZRXUSDT:4:1">ZRXUSDT</option>
        <option value="RPLUSDT:3:1">RPLUSDT</option>
        <option value="ALICEUSDT:3:1">ALICEUSDT</option>
        <option value="IMXUSDT:4:0">IMXUSDT</option>
        <option value="ENAUSDT:4:0">ENAUSDT</option>
        <option value="ADAUSDT:4:0">ADAUSDT</option>
        <option value="AAVEUSDT:2:1">AAVEUSDT</option>
        <option value="FARTCOINUSDT:4:1">FARTCOINUSDT</option>
        <option value="BNBUSDT:2:2">BNBUSDT</option>
        <option value="WIFUSDT:4:1">WIFUSDT</option>
        <option value="HBARUSDT:5:0">HBARUSDT</option>
        <option value="LTCUSDT:2:3">LTCUSDT</option>
        <option value="ONDOUSDT:4:1">ONDOUSDT</option>
        <option value="1000BONKUSDT:6:0">1000BONKUSDT</option>
        <option value="AVAXUSDT:3:0">AVAXUSDT</option>
        <option value="TRXUSDT:5:0">TRXUSDT</option>
        <option value="WLDUSDT:4:0">WLDUSDT</option>
        <option value="XLMUSDT:5:0">XLMUSDT</option>
        <option value="1000SHIBUSDT:6:0">1000SHIBUSDT</option>
        <option value="DOTUSDT:3:1">DOTUSDT</option>
        <option value="NEARUSDT:3:0">NEARUSDT</option>
        <option value="JUPUSDT:4:0">JUPUSDT</option>
        <option value="ALGOUSDT:4:1">ALGOUSDT</option>
        <option value="NEIROUSDT:7:0">NEIROUSDT</option>
        <option value="ORDIUSDT:3:1">ORDIUSDT</option>
        <option value="AI16ZUSDT:4:1">AI16ZUSDT</option>
        <option value="AIXBTUSDT:5:0">AIXBTUSDT</option>
        <option value="FILUSDT:3:1">FILUSDT</option>
        <option value="LDOUSDT:4:0">LDOUSDT</option>
        <option value="SWARMSUSDT:4:0">SWARMSUSDT</option>
        <option value="CRVUSDT:3:1">CRVUSDT</option>
        <option value="TIAUSDT:4:0">TIAUSDT</option>
        <option value="PENGUUSDT:6:0">PENGUUSDT</option>
        <option value="ARBUSDT:4:1">ARBUSDT</option>
        <option value="UNIUSDT:3:0">UNIUSDT</option>
        <option value="VIRTUALUSDT:4:1">VIRTUALUSDT</option>
        <option value="BCHUSDT:2:3">BCHUSDT</option>
        <option value="SPXUSDT:4:0">SPXUSDT</option>
        <option value="ENSUSDT:3:1">ENSUSDT</option>
        <option value="ETCUSDT:3:2">ETCUSDT</option>
        <option value="APTUSDT:4:1">APTUSDT</option>
        <option value="POPCATUSDT:4:0">POPCATUSDT</option>
        <option value="GALAUSDT:5:0">GALAUSDT</option>
        <option value="OPUSDT:4:1">OPUSDT</option>
        <option value="BOMEUSDT:6:0">BOMEUSDT</option>
        <option value="FETUSDT:4:0">FETUSDT</option>
        <option value="INJUSDT:3:1">INJUSDT</option>
        <option value="GMTUSDT:5:0">GMTUSDT</option>
        <option value="SANDUSDT:5:0">SANDUSDT</option>
        <option value="RAYSOLUSDT:4:1">RAYSOLUSDT</option>
        <option value="1000CHEEMSUSDT:7:0">1000CHEEMSUSDT</option>
        <option value="GRIFFAINUSDT:5:0">GRIFFAINUSDT</option>
        <option value="1000FLOKIUSDT:5:0">1000FLOKIUSDT</option>
        <option value="SEIUSDT:4:0">SEIUSDT</option>
        <option value="TURBOUSDT:7:0">TURBOUSDT</option>
        <option value="MOVEUSDT:4:0">MOVEUSDT</option>
        <option value="1000SATSUSDT:7:0">1000SATSUSDT</option>
        <option value="ATOMUSDT:3:2">ATOMUSDT</option>
        <option value="DYDXUSDT:3:1">DYDXUSDT</option>
        <option value="APEUSDT:4:0">APEUSDT</option>
        <option value="TONUSDT:4:1">TONUSDT</option>
        <option value="ZENUSDT:3:1">ZENUSDT</option>
        <option value="RUNEUSDT:3:0">RUNEUSDT</option>
        <option value="TRUMPUSDT:3:2">TRUMPUSDT</option>
        <option value="ARCUSDT:5:0">ARCUSDT</option>
        <option value="JTOUSDT:4:0">JTOUSDT</option>
        <option value="DOGSUSDT:7:0">DOGSUSDT</option>
        <option value="AVAAIUSDT:5:0">AVAAIUSDT</option>
        <option value="VETUSDT:6:0">VETUSDT</option>
        <option value="CHILLGUYUSDT:5:0">CHILLGUYUSDT</option>
        <option value="ARKMUSDT:4:0">ARKMUSDT</option>
        <option value="ZEREBROUSDT:5:0">ZEREBROUSDT</option>
        <option value="STXUSDT:4:0">STXUSDT</option>
        <option value="NOTUSDT:6:0">NOTUSDT</option>
        <option value="SUSHIUSDT:4:0">SUSHIUSDT</option>
        <option value="ICPUSDT:3:0">ICPUSDT</option>
        <option value="MORPHOUSDT:4:1">MORPHOUSDT</option>
        <option value="VANAUSDT:3:2">VANAUSDT</option>
        <option value="JASMYUSDT:6:0">JASMYUSDT</option>
        <option value="PENDLEUSDT:4:0">PENDLEUSDT</option>
        <option value="CGPTUSDT:5:0">CGPTUSDT</option>
        <option value="MEUSDT:3:1">MEUSDT</option>
        <option value="ALCHUSDT:5:0">ALCHUSDT</option>
        <option value="COOKIEUSDT:4:0">COOKIEUSDT</option>
        <option value="SONICUSDT:4:1">SONICUSDT</option>
        <option value="ZROUSDT:4:1">ZROUSDT</option>
        <option value="1000RATSUSDT:5:0">1000RATSUSDT</option>
        <option value="MEMEUSDT:6:0">MEMEUSDT</option>
        <option value="AIUSDT:5:0">AIUSDT</option>
        <option value="STRKUSDT:4:1">STRKUSDT</option>
        <option value="AXSUSDT:3:0">AXSUSDT</option>
        <option value="1000CATUSDT:5:0">1000CATUSDT</option>
        <option value="GRTUSDT:5:0">GRTUSDT</option>
        <option value="PYTHUSDT:5:0">PYTHUSDT</option>
        <option value="MANAUSDT:4:0">MANAUSDT</option>
        <option value="MKRUSDT:1:3">MKRUSDT</option>
        <option value="COMPUSDT:2:3">COMPUSDT</option>
        <option value="THETAUSDT:4:1">THETAUSDT</option>
        <option value="XTZUSDT:3:1">XTZUSDT</option>
        <option value="CHZUSDT:5:0">CHZUSDT</option>
        <option value="ARUSDT:3:1">ARUSDT</option>
        <option value="CFXUSDT:5:0">CFXUSDT</option>
        <option value="MASKUSDT:4:0">MASKUSDT</option>
        <option value="DEXEUSDT:3:2">DEXEUSDT</option>
        <option value="XAIUSDT:5:0">XAIUSDT</option>
        <option value="FLOWUSDT:3:1">FLOWUSDT</option>
        <option value="STGUSDT:4:0">STGUSDT</option>
        <option value="BBUSDT:5:0">BBUSDT</option>
        <option value="NEOUSDT:3:2">NEOUSDT</option>
        <option value="PHAUSDT:5:0">PHAUSDT</option>
        <option value="ORCAUSDT:3:1">ORCAUSDT</option>
        <option value="MANTAUSDT:4:1">MANTAUSDT</option>
        <option value="ONTUSDT:4:1">ONTUSDT</option>
        <option value="SXPUSDT:4:1">SXPUSDT</option>
        <option value="1000LUNCUSDT:5:0">1000LUNCUSDT</option>
        <option value="WUSDT:5:1">WUSDT</option>
        <option value="HIVEUSDT:5:0">HIVEUSDT</option>
        <option value="ZILUSDT:5:0">ZILUSDT</option>
        <option value="BIGTIMEUSDT:5:0">BIGTIMEUSDT</option>
        <option value="MEWUSDT:6:0">MEWUSDT</option>
      </select>
      <input type="radio" id="1m" name="period" onclick="updatePeriod('1m')"> 1m
      <input type="radio" id="3m" name="period" onclick="updatePeriod('3m')"> 3m
      <input type="radio" id="5m" name="period" onclick="updatePeriod('5m')"> 5m
      <input type="radio" id="15m" name="period" checked onclick="updatePeriod('15m')"> 15m
      <input type="radio" id="30m" name="period" onclick="updatePeriod('30m')"> 30m
      <input type="radio" id="1h" name="period" onclick="updatePeriod('1h')"> 1h
      <input type="radio" id="2h" name="period" onclick="updatePeriod('2h')"> 2h
      <input type="radio" id="4h" name="period" onclick="updatePeriod('4h')"> 4h
      <input type="radio" id="6h" name="period" onclick="updatePeriod('6h')"> 6h
      <input type="radio" id="8h" name="period" onclick="updatePeriod('8h')"> 8h
      <input type="radio" id="12h" name="period" onclick="updatePeriod('12h')"> 12h
      <input type="radio" id="1d" name="period" onclick="updatePeriod('1d')"> 1d
    </div>
    <canvas id="myCanvas" width="1268" height="460" style="border:1px solid #a9a09bcb;"></canvas>
    <textarea id="output" >hello</textarea>
    <script>
      let symbol = "BTCUSDT"
      let period = "15m";
      let version = "1";
      let postions = new Set();
      let symbolPricePoint = 1;
      let symbolQuantityPoint = 3;
      let maxPrice = 0;
      let lastTimerId = null;
      let minPrice = 999999999;
      let sl_value = 5;
      let disPricePerPixel = 0;
      let latestMaxPrice = 0;
      let latestPrice = 0;
      let scaleRatio = 0;
      let switchEnable = true;
      let periodEnable = false;
      let stopEnable = false;
      let stopPriceExist = false;
      let stopPrice = 0;
      let stopSell = false;
      let options = document.getElementById("symbol").options;
      let symbolIdx = 0;
      let rspArr = null;
      let ctx;
      let periodarray = ["1m", "3m", "5m", "15m"];
      let periodidx = 0;
      function output(text) {
        textarea = document.getElementById("output");
        textarea.value += "\n" + text;
        textarea.scrollTop = textarea.scrollHeight;
      }
      function updatePeriod(_period) {
        period = _period;
        updateChart();
      }
      function updateSymbol() {
        let sel = document.getElementById("symbol");
        let arr = sel.options[sel.selectedIndex].value.split(":");
        symbol = arr[0];
        symbolPricePoint = parseInt(arr[1]);
        symbolQuantityPoint = parseInt(arr[2]);
        for(let i = 0; i < options.length; ++i) {
          let symbolmix = options[i].value;
          let arr = symbolmix.split(":");
          let _symbol = arr[0];
          if(_symbol == symbol) {
            symbolIdx = i;
            break;
          }
        }
        updateChart();
        periodidx = 0;
      }
      function getPeriod() {
        if(document.getElementById("1m").checked) {
          return "1m";
        }
        if(document.getElementById("3m").checked) {
          return "3m";
        }
        if(document.getElementById("5m").checked) {
          return "5m";
        }
        if(document.getElementById("15m").checked) {
          return "15m";
        }
        if(document.getElementById("30m").checked) {
          return "30m";
        }
        if(document.getElementById("1h").checked) {
          return "1h";
        }
        if(document.getElementById("2h").checked) {
          return "2h";
        }
        if(document.getElementById("4h").checked) {
          return "4h";
        }
        if(document.getElementById("6h").checked) {
          return "6h";
        }
        if(document.getElementById("8h").checked) {
          return "8h";
        }
        if(document.getElementById("12h").checked) {
          return "12h";
        }
        if(document.getElementById("1d").checked) {
          return "1d";
        }
        if(document.getElementById("3d").checked) {
          return "3d";
        }
        if(document.getElementById("1w").checked) {
          return "1w";
        }
      }
      function timerFunc() {
        if(!switchEnable) {
          lastTimerId = setTimeout(timerFunc, 1000);
          return;
        }
        if(++symbolIdx >= options.length) {
            symbolIdx = 0;
        }
        document.getElementById(period).checked = true;
        let symbolmix = options[symbolIdx].value;
        let arr = symbolmix.split(":");
        symbol = arr[0];
        symbolPricePoint = parseInt(arr[1]);
        symbolQuantityPoint = parseInt(arr[2]);
        output([symbol, symbolPricePoint, symbolQuantityPoint, symbolIdx]);
        document.getElementById("symbol").value = symbolmix;
        updateChart();
        ++periodidx;
      }
      function mousedown(x, y) {
        // output(["mousedown", x, y]);
        switchEnable = !switchEnable;
        output("switchEnable: " + switchEnable);
      }
      function mousemove(x, y) {
        redrawChart(2);
        ctx.beginPath();
        ctx.strokeStyle = "purple";
        ctx.setLineDash([3,3]);
        let price = latestMaxPrice - y * disPricePerPixel;
        ctx.moveTo(0, y);
        ctx.lineTo(1200, y);
        ctx.stroke();
        ctx.setLineDash([]);
        ctx.fillStyle = "purple";
        ctx.textBaseline = "middle";
        ctx.textAlign = "start";
        ctx.fillText(price.toFixed(symbolPricePoint), 1205, y);
      }
      function redrawChart(type) {
        if(type == 0) {
          scaleRatio += 0.1;
        } else if(type == 1) {
          scaleRatio -= 0.1;
        }
        // output([scaleRatio, rspArr.length, maxPrice, minPrice]);
        ctx.clearRect(0, 0, 1268, 460);
        let disPrice = maxPrice - minPrice;
        latestMaxPrice = maxPrice + disPrice * scaleRatio;
        disPrice = disPrice + disPrice * scaleRatio * 2;
        disPricePerPixel = disPrice / 450;
        if(type < 2) {
          // output([latestMaxPrice, disPrice, disPricePerPixel, scaleRatio]);
        }
        if(postions.has(symbol)) {
          ctx.save();
          ctx.fillStyle = "purple";
          ctx.textBaseline = "middle";
          ctx.font = "40px Arial";
          ctx.globalAlpha = 0.7;
          ctx.textAlign = "start";
          ctx.fillText("已持仓", 300, 67);
          ctx.restore();
        }
        for(let i = 0; i < 10; ++i) {
          ctx.beginPath();
          ctx.strokeStyle = "#e1dedccb";
          let price = latestMaxPrice - (i+1) * 42 * disPricePerPixel;
          ctx.moveTo(0, (i+1) * 42);
          ctx.lineTo(1200, (i+1) * 42);
          ctx.stroke();
          ctx.fillStyle = "black";
          ctx.textBaseline = "middle";
          ctx.textAlign = "start";
          ctx.fillText(price.toFixed(symbolPricePoint), 1205, (i+1) * 42);
        }
        if(rspArr == null) {
          return;
        }
        let kCount = rspArr.length;
        let latestDate = new Date(rspArr[kCount-1][0]);
        ctx.textAlign = "center";
        ctx.textBaseline = "hanging";
        ctx.fillText(latestDate.toLocaleTimeString(), 1200, 440);
        for(let i = 0; i < kCount; ++i) {
          let arr = rspArr[i];
          let open = arr[1];
          let high = arr[2];
          let low = arr[3];
          let close = arr[4];
          let x = (i + 200 - kCount) * 6;
          let y = 0;
          let h = 0;
          ctx.beginPath();
          if(close > open) {
            ctx.fillStyle = "green";
            ctx.strokeStyle = "green";
            y = parseInt((latestMaxPrice - close) / disPricePerPixel);
            h = close - open;
          } else {
            ctx.fillStyle = "red";
            ctx.strokeStyle = "red";
            y = parseInt((latestMaxPrice - open) / disPricePerPixel);
            h = open - close;
          }
          h = parseInt(h / disPricePerPixel);
          ctx.fillRect(x, y, 4, h);
          ctx.moveTo(x + 2, y);
          ctx.lineTo(x + 2, parseInt((latestMaxPrice - high) / disPricePerPixel));
          ctx.moveTo(x + 2, y + h);
          ctx.lineTo(x + 2, parseInt((latestMaxPrice - low) / disPricePerPixel));
          ctx.stroke();
        }
      }

      function updateChart() {
        minPrice = 999999999;
        maxPrice = 0;
        scaleRatio = 0;
        stopEnable = false;
        stopPriceExist = false;
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4) {
            let rspObj = JSON.parse(xhr.response);
            let retcode = rspObj.retcode;
            if(retcode == 1) {
              alert(`你的版本太低，请刷新网站
Your version is outdated, please refresh the website.`);
              return;
            }
            if(retcode == 2) {
              alert(`目前网站的访问量太大，请稍候重试
Our website is currently experiencing high traffic, please try again later.`);
              return;
            }
            if(retcode == 3) {
              alert(`检测到你的访问频率过高，请稍候重试
We've detected unusually high traffic from your device, please try again later.`);
              return;
            }
            if(retcode == 100) {
              let msg = rspObj.msg;
              alert(msg);
              return;
            }
            if(retcode != 0) {
              alert(`返回码非法，返回码不为0
Invalid return code: the value must be 0.`);
              return;
            }
            rspArr = rspObj.data;
            let kCount = rspArr.length;
            output(kCount);
            rspArr.forEach(function(arr, idx) {
              let high = parseFloat(arr[2]);
              let low = parseFloat(arr[3]);
              if(high > maxPrice) {
                maxPrice = high;
              }
              if(low < minPrice) {
                minPrice = low;
              }
            });
            let disPrice = maxPrice - minPrice;
            latestMaxPrice = maxPrice;
            disPricePerPixel = disPrice / 450;
            ctx.clearRect(0, 0, 1268, 460);
            for(let i = 0; i < 10; ++i) {
              ctx.beginPath();
              ctx.strokeStyle = "#e1dedccb";
              let price = maxPrice - (i+1) * 42 * disPricePerPixel;
              ctx.moveTo(0, (i+1) * 42);
              ctx.lineTo(1200, (i+1) * 42);
              ctx.stroke();
              ctx.fillStyle = "black";
              ctx.textBaseline = "middle";
              ctx.textAlign = "start";
              ctx.fillText(price.toFixed(symbolPricePoint), 1205, (i+1) * 42);
            }
            let latestDate = new Date(rspArr[kCount-1][0]);
            ctx.textAlign = "center";
            ctx.textBaseline = "hanging";
            ctx.fillText(latestDate.toLocaleTimeString(), 1200, 440);
            for(let i = 0; i < kCount; ++i) {
              let arr = rspArr[i];
              let open = parseFloat(arr[1]);
              let high = parseFloat(arr[2]);
              let low = parseFloat(arr[3]);
              let close = parseFloat(arr[4]);
              latestPrice = close;
              let x = (i + 200 - kCount) * 6;
              let y = 0;
              let h = 0;
              ctx.beginPath();
              if(close > open) {
                ctx.fillStyle = "green";
                ctx.strokeStyle = "green";
                y = parseInt((maxPrice - close) / disPricePerPixel);
                h = close - open;
              } else {
                ctx.fillStyle = "red";
                ctx.strokeStyle = "red";
                y = parseInt((maxPrice - open) / disPricePerPixel);
                h = open - close;
              }
              h = parseInt(h / disPricePerPixel);
              ctx.fillRect(x, y, 4, h);
              ctx.moveTo(x + 2, y);
              ctx.lineTo(x + 2, parseInt((maxPrice - high) / disPricePerPixel));
              ctx.moveTo(x + 2, y + h);
              ctx.lineTo(x + 2, parseInt((maxPrice - low) / disPricePerPixel));
              ctx.stroke();
            }
            lastTimerId != null && clearTimeout(lastTimerId);
            lastTimerId = setTimeout(timerFunc, 10000);
          }
        }
        xhr.open('post', '/chart', true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
        xhr.send("symbol="+symbol+"&period="+period+"&version="+version);
      }
      
      window.onload = function() {
        output("onload..........");
        const canvas = document.getElementById("myCanvas");
        addEventListener("keydown", function(ev) {
          if(ev.keyCode == 70) {
            redrawChart(0);
          } else if(ev.keyCode == 68) {
            redrawChart(1);
          } else if(ev.keyCode == 65) {
            switchEnable = !switchEnable;
            output("switchEnable: " + switchEnable);
          }
        });
        canvas.addEventListener("mousedown", function(ev) {
          let rect = canvas.getBoundingClientRect();
          let x = ev.clientX - rect.left;
          let y = ev.clientY - rect.top;
          mousedown(x, y);
        });
        canvas.addEventListener("mousemove", function(ev) {
          let rect = canvas.getBoundingClientRect();
          let x = ev.clientX - rect.left;
          let y = ev.clientY - rect.top;
          mousemove(x, y);
        });
        ctx = canvas.getContext("2d");
        updateChart();
      }
      </script>
  </body>
</html>